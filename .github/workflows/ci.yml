name: CI/CD Pipeline

on:
  push:
    branches: [master, main, dev]
  pull_request:
    branches: [master, main, dev]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun test

      - name: Run tests with coverage
        run: bun test --coverage

      - name: Archive coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check for syntax errors
        run: |
          bun -c src/worker.js
          bun -c src/commands.js
          bun -c src/i18n.js

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build info
        run: |
          echo "âœ… All tests passed!"
          echo "ðŸš€ Ready to deploy via Cloudflare integration"
          echo "Deploy automÃ¡tico via Cloudflare Pages/Workers"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check for vulnerabilities
        run: |
          echo "Security audit with Bun"
          bun install --production
        continue-on-error: true
